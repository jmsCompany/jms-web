<script type="text/html" id="mrbBody">
    <div class="container-fluid">
        <div class="row">
            <!-- form: -->
            <section>
                <form id="mrbForm" method="post" action="index.html" class="form-inline returnPCM_Form">
                    <!--<div class="alert alert-success" style="display: none;"></div>-->
                    <div class="body-head-title">
                        <span class="h-title" id="po01">来料清单</span>
                        <span class="h-title" id="po02">新建来料</span>
                        <span class="h-title" id="po04">检验入库</span>
                        <span class="h-title" id="po03">采购退货</span>
                        <span class="h-title-selected"><b id="sub-current-title">新建采购退货</b></span>
                    </div>
                    <div class="col-xs-12 mar-top-20px">
                        <div class="form-group">
                            <label for="" class="input-w-160">退货单编码</label>
                            <input type="text" class="form-control input-w-3" name="mtNo" id="mtNo" readonly  unselectable="on"/>
                        </div>
                        <div class="form-group detail" style="display: none;">
                            <label for="" class="input-w-160">下单日期</label>
                            <input type="text" class="form-control input-w-3" name="creationTime" id="creationTime">
                        </div>
                        <div class="form-group detail" style="display: none;">
                            <label for="" class="input-w-160">下单员</label>
                            <input type="text" class="form-control input-w-3" name="empMtUser" id="empMtUser">
                        </div>
                    </div>
                    <div class="col-xs-12 mar-top-20px">
                        <div class="form-group">
                            <label for="" class="input-w-160">供应商</label>
                            <select class="input-w-3 select-cs1 form-control" name="sCompanyCoId:number" id="sCompanyCoId">
                                <option value="">供应商</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="" class="input-w-160">采购单编码</label>
                            <select class="input-w-3 select-cs1 form-control" name="codePo:number" id="codePo">
                                <option value="">采购订单编码</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="" class="input-w-160">从仓库</label>
                            <select class="input-w-3 select-cs1 form-control toStkSelect" name="fromStkId:number" id="fromStkId">
                                <option value="">从仓库</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="" class="input-w-160">到仓库</label>
                            <select class="input-w-3 select-cs1 form-control toStkSelect" name="toStkId:number" id="toStkId">
                                <option value="">到仓库</option>
                            </select>
                        </div>
                    </div>

                    <!--<div class="col-md-10 col-md-offset-1 mar-top-20px">-->
                        <!--<div class="form-group">-->
                            <!--<ul class="new-income-list-nav" id="matlist-ul">-->
                                <!--<li style="width:170px">物料</li>-->
                                <!--<li>单位</li>-->
                                <!--<li style="width:90px">交货日期</li>-->
                                <!--<li>数量</li>-->
                                <!--<li style="margin-left:-19px;width:85px;">批号</li>-->
                                <!--<li style="width:88px">从货架</li>-->
                                <!--<li style="width:88px">备注</li>-->
                                <!--<li style="width:80px">退货数量</li>-->
                                <!--&lt;!&ndash;<li style="min-width:30px;" id="hide01">操作</li>&ndash;&gt;-->
                            <!--</ul>-->
                        <!--</div>-->
                        <!--<div class="form-group" id="matlist" >-->
                        <!--</div>-->
                    <!--</div>-->
                    <!-- +\- over -->
                    <div class="col-xs-12 mar-top-20px changerep_cont">
                        <table id="" cellpadding="0" cellspacing="0" width="872px">
                            <tr>
                                <th width="169px"> 物料 </th>
                                <th width="71px"> 单位</th>
                                <th width="92px"> 交货日期</th>
                                <th width="69px"> 已收数量</th>
                                <th width="87px"> 批号 </th>
                                <th width="88px"> 从货架</th>
                                <th width="88px"> 到货架</th>
                                <th width="88px"> 备注</th>
                                <th width="80px"> 库存</th>
                                <th width="81px"> 退货数量</th>
                                <th width="47px" id="operation"> 操作</th>
                            </tr>
                        </table>

                        <div class="form-group" id="matlist">
                        </div>   <!-- +\- over -->
                    </div>
                    <!--<div class="col-md-12"> -->
                    <!--<label for="" id="" class="input-w-160">备注</label>-->
                    <!--<textarea class="form-control input-w-300" rows="3" name="remark1" id="remark1"></textarea>-->
                    <!--</div>-->
                    <div class="clearfix"></div>
                    <div class="foot-btn-box">
                        <div class="form-group">
                            <button class="btn btn-primary" id="save">保存</button>
                            <button class="btn btn-info" type="button" id="return01">返回</button>
                        </div>
                    </div>
                    <input type="hidden" id="idMt" name="idMt:number" />
                    <input type="hidden" id="statusId" name="statusId:number"  value="6" />
                    <input type="hidden" id="typeId" name="typeId:number" value="2"/>
                </form>
            </section>
            <!-- :form -->
        </div>
    </div>
    <div class="tcbox container-fluid" id="nullAlert">
        <div class="tcbox_cont row">
            <div class="body-head-title">
            </div>
            <input type="button" class="tc_close" onClick="javascript:hideObj('#nullAlert');">
            <div class="col-xs-12 mar-top-20px">
                <div class="form-group">
                    <label id="info"></label>
                </div>
            </div>
        </div>
    </div>
</script>
<script type="text/html" id="mrbItem">

<dl class="matlist" id="item<%= item %>">
    <!--<dd class="income-create-list" style="width: 100%;padding-left: 58px;">-->
    <dd class="income-create-list">
            <input style="width:128px" readonly type="text" class="a" name="smtfItems[item<%= item %>][material]" id="smtfItems.item<%= item %>.material" placeholder="物料" value="<%= data.materialPno %>-<%= data.materialDes %>-<%= data.materialRev %>"/>
            <input style="width:68px" readonly type="text" class="i" name="smtfItems[item<%= item %>][unitPur]:number" id="smtfItems.item<%= item %>.unitPur" placeholder="单位" value="<%= data.marterialUnit %>"/>
            <input style="width:86px" readonly type="text" class="b" name="smtfItems[item<%= item %>][deliveryDate]:number" id="smtfItems.item<%= item %>.deliveryDate" placeholder="交货日期" value="<%= data.deliveryDate %>"/>
            <input style="width:67px" type="text" readonly class="o" name="smtfItems[item<%= item %>][qtyReceived]" id="smtfItems.item<%= item %>.qtyReceived" value="<%= data.qtyReceived %>"/>
            <!--<input style="width:67px" readonly type="text" class="c" name="smtfItems[item<%= item %>][qtyPo]:number" id="smtfItems.item<%= item %>.qtyPo" placeholder="数量" value="<%= data.qtyPo %>"/>-->
            <input style="width:72px" readonly type="text" class="d" name="smtfItems[item<%= item %>][lotNo]" id="smtfItems.item<%= item %>.lotNo" placeholder="批号" value="<%= data.lotNo %>"/>
            <input style="width:70px" readonly type="text" class="e" name="smtfItems[item<%= item %>][fromBin]" id="smtfItems.item<%= item %>.fromBin" placeholder="从货架" value="<%= data.fromBin %>"/>
            <input type="hidden" readonly class="k" name="smtfItems[item<%= item %>][fromBinId]" id="smtfItems.item<%= item %>.fromBinId" placeholder="从货架" value="<%= data.fromBinId %>"/>




        <select class="select-cs1 b" style="width:83px" data-id="<%= data.toBinId %>" name="smtfItems[item<%= item %>][toBinId]:number" id="smtfItems.item<%= item %>.toBinId">
            <% if(data.fromBinId) { %>
            <option value="<%= data.toBinId %>"><%= data.toBin %></option>
            <% } else { %>
            <option value="">从货架</option>
            <% } %>
        </select>


            <input style="width:75px" readonly type="text" class="f" name="smtfItems[item<%= item %>][remark]" id="smtfItems.item<%= item %>.remark" placeholder="备注" value="<%= data.remark %>"/>
            <input style="width:77px" readonly type="text" class="n" name="smtfItems[item<%= item %>][inventoryQty]:number" id="smtfItems.item<%= item %>.inventoryQty" placeholder="库存" value="<%= data.inventoryQty %>"/>
            <input style="width:77px" type="text" class="h" name="smtfItems[item<%= item %>][qty]:number" id="smtfItems.item<%= item %>.qty" placeholder="退货数量" value="<%= data.qty %>"/>
            <input type="hidden" readonly class="j" name="smtfItems[item<%= item %>][materialId]:number" id="smtfItems.item<%= item %>.materialId" value="<%= data.materialId %>"/>
            <input type="hidden" readonly class="l" name="smtfItems[item<%= item %>][poMaterialId]:number" id="smtfItems.item<%= item %>.poMaterialId" value="<%= data.poMaterialId %>"/>
            <input type="hidden" readonly class="m" name="smtfItems[item<%= item %>][typeId]:number" id="smtfItems.item<%= item %>.typeId"  value="2"/>
            <% if(action != 'detail') { %>
            <span style="width:12%" class="action">
                <!--<a class="button-sytle1 new-income-add">+</a>-->
                <a class="button-sytle1 new-income-delete" style="margin: 0;">-</a>
            </span>
            <% } %>
    </dd>
</dl>
</script>
<!--新建采购退货-->
<script type="text/javascript">
var jmstoken= store.get('JMS-TOKEN');
//弹窗
function showObj(objid){
    $(objid).show();

}
function hideObj(objid){
    $(objid).hide();
}
var newIncomeListEntry = {
    init: function () {
        this.mrbItem = _.template($('#mrbItem').html());

        var params = this.params = RouterManager.getParams();
        var groupId=params['groupId'];

        $('#body').html($('#mrbBody').html());

        this.$matList = $('#matlist');
        this.initData();
        //绑定事件

        this.bindEvents(groupId);
        this.form();
    },
    initData: function() {
        var self = this;
        var params=RouterManager.getParams();
        var action=params['action'];
        var idMt = params['mrbId'];

        if(idMt) {
            this.loadDetail(idMt, function() {
                self.dealAction(action);
            });
        } else {
            this.initNew();
//            this.$matList.append(this.createRow());
        }
    },
    loadDetail: function(idMt, callback) {
        var self = this;
        $.mtfInfo(idMt,jmstoken, function(data) {
            $(".detail").show();
            $('#mrbForm').populate(data, true);
            $('#creationTime').val($.dateFormat.date(new Date(data.creationTime), 'yyyy-MM-dd'));

            var smtfItems = '';
            _(data.smtfItems).each(function(item) {
                smtfItems += self.createRow(item);
            });
            self.$matList.append(smtfItems);

            self.fillSCompanyCo(function() {
                $('#sCompanyCoId').val(data.coCompanyId);
                self.fillCodePo(function() {
                    $('#codePo').val(data.poId)
                });
            });


            $('#fromStkId').html('<option value="' + data.fromStkId + '">' + data.fromStk + '</option>');
            $('#toStkId').html('<option value="' + data.toStkId + '">' + data.toStk + '</option>');

//            self.fillFromStk(function() {
//                $('#fromStkId').val(data.fromStkId);
//            });

            callback && callback();
        });
    },
    initNew: function() {
        var self = this;
        //如果是编辑页面，去除收货数量显示
//        $('[id*="inspection"]').remove();
        self.fillSCompanyCo();

        self.fillFromStk();
        $.mtfStkInfo('PO',jmstoken,function(data) {
            $('#toStkId').val(data.idStk);
        });
    },
    dealAction: function(action) {
        if(action=='detail') {
            $('#hide01').hide();
            $('#sub-current-title').html('采购退货详情');
            //如果是详情页面的话
            $('input,select,textarea',$('#mrbForm')).prop('disabled',true);
            $('#_key31').val("");
            $('#save').hide();
            $('#operation').hide();
            $('table','#mrbForm').attr('width','825px');
        }
    },
    defaultData: {},
    createRow: function(data) {
        var self = this;
        var row = parseInt(self.$matList.data('row'));

        if(!row) {
            row = 1;
        }

        if(!data) {
            data = self.defaultData;
        }

        var param = {
            data: data,
            item: row,
            action: self.params.action
        }

        var html = self.mrbItem(param);
        self.$matList.data('row', row + 1);

        return html;
    },
    addRow: function(e) {
        e.stopPropagation();

        var $t = $(e.target);
        var html = this.createRow();

        $t.closest('dl').after(html);
    },
    delRow: function(e) {
        var $t = $(e.target);
        if(this.$matList.find('.matlist').length == 1) {
            return;
        }
        $t.closest('dl').remove();
    },
    loadToBin: function($el, callback) {
        if(!$el) {
            $el = $('.g');
        } else {
            $el = $el.find('.g');
        }
        $.mtfBinInfo(8,'PO',jmstoken,function(data){
            $el.val(data.idBin);
        });
    },
    fillSCompanyCo: function(callback) {
        $('#sCompanyCoId').selectautofill('s/getCompanyCoList',{headers:{'JMS-TOKEN':store.get('JMS-TOKEN')},data:{'coCompanyType':1}}, callback);
    },
    fillCodePo: function(callback) {
        var codePoDom = $('#codePo');
        var codeCo = $('#sCompanyCoId').val();

        codePoDom.empty();

        codePoDom.append("<option>采购单编码</option>");
        codePoDom.selectautofill('s/spoList', {headers: {'JMS-TOKEN': store.get('JMS-TOKEN')},data: {'codeCo': codeCo}}, callback);
    },
    fillFromStk: function(callback) {
        $('#fromStkId').selectautofill('s/getStksByTypes?statusId=27&types=4&types=1&types=5',{headers:{'JMS-TOKEN':store.get('JMS-TOKEN')}});
        $('#toStkId').selectautofill('s/getStksByTypes?statusId=27&types=5&types=10&types=11',{headers:{'JMS-TOKEN':store.get('JMS-TOKEN')}});

//        $('#fromStkId').selectautofill('s/getStks',{headers:{'JMS-TOKEN':store.get('JMS-TOKEN')},data:{'statusId':27}}, callback);
    },
    bindEvents: function (groupId) {
        var jmstoken= store.get('JMS-TOKEN');
        var historyParams={
            groupId:'incomeList'
        };
        $('#return01').click(function () {
            if(groupId == 'mtfList'){
                var typeId = $('#typeId').val();
                $.get("views/mtfList.html", function (data) {
                    $("#body").html(data);
                    RouterManager.setUrl({
                        groupId:'mtfList',
                        typeId:typeId
                    });
                });
            }
            else{
                $.get("views/mrbList.html", function (data) {
                    $("#body").html(data);
                    RouterManager.setUrl({
                        groupId:'incomeList',
                        viewId:'mrbList'
                    });
                });
            }
        });
        //来料入库
        $("#po01").click(function () {
            $.get("views/incomeList.html", function (data) {
//                delete historyParams.type;
                RouterManager.setUrl(historyParams);
                $("#body").html(data);
            });
        });
        //新建入检
        $("#po02").click(function () {
            $.get("views/incomeList-create-body.html", function (data) {
                historyParams.viewId='incomeList-create-body';
                RouterManager.setUrl(historyParams);
                $("#body").html(data);
            });
        });
        //新建入库
        $("#po04").click(function () {
            $.get("views/incomeList-checked-body.html", function (data) {
                historyParams.viewId='incomeList-checked-body';
                RouterManager.setUrl(historyParams);
                $("#body").html(data);
            });
        });
        //采购退货
        $("#po03").click(function () {
            $.get("views/mrbList.html", function (data) {
                historyParams.viewId='mrbList';
                RouterManager.setUrl(historyParams);
                $("#body").html(data);
            });
        });

        var pushData = [];

        var lotNoList = [];
        var self = this;
        var $mrbForm = $('#mrbForm');
        //增加行
        $mrbForm.on('click.nrpAdd', '.new-income-add', self.addRow.bind(self));
        //删除行
        $mrbForm.on('click.nrpDel', '.new-income-delete', self.delRow.bind(self));
        $mrbForm.on('focus', 'input, select', function(e) {
            $(this).removeClass('error');
        });
        //到仓库change事件,修改供应商列表
        $mrbForm.on("change.nrpJMS", "#fromStkId", function () {//修改成这样的写法
            $('.e').empty();
            var idStk = $(this).val();
            $(".e").selectautofill('s/getBins', {
                headers: {'JMS-TOKEN': store.get('JMS-TOKEN')},
                data: {'idStk': idStk}
            });
            self.findWSSMtfMaterialBySpoIdAndStkId();
        });
        //采购单编码的change事件,修改物料编号列表
        $mrbForm.on("change.changeOrderID", "#codePo", self.findWSSMtfMaterialBySpoIdAndStkId.bind(self));

        //供应商change事件,修改采购单编码
        $mrbForm.on("change.changeSupplier", "#sCompanyCoId", function () {
            self.fillCodePo();
        });

        $mrbForm.on("change","#toStkId", function(){
            var $list = $('#matlist');
            var $items = $list.find('.matlist');
            $items.each(function(i) {
                var $dl = $(this);
                self.fillFromBin($dl);
            });
        });
    },
    fillFromBin: function($el, callback) {
        var idStk = $('#toStkId').val();
        var $b = $el.find('.b');
        $b.empty();
//            $el.selectautofill('s/getBins',{headers:{'JMS-TOKEN':store.get('JMS-TOKEN')},data:{'idStk':idStk}}, function() {});
        $b.selectautofill('s/getBins',{headers:{'JMS-TOKEN':store.get('JMS-TOKEN')},data:{'idStk':idStk}}, callback);
    },
    form: function() {
        var self = this;
        $('#mrbForm').bootstrapValidator({
            message: 'This value is not valid',
            feedbackIcons: {
                valid: 'glyphicon glyphicon-ok',
                invalid: 'glyphicon glyphicon-remove',
                validating: 'glyphicon glyphicon-refresh'
            },
            fields: {
//                'mtNo': {
//                    validators: {
//                        notEmpty: {
//                            message: '请填写退货单编码'
//                        }
//                    }
//                },
                'sCompanyCoId:number': {
                    validators: {
                        notEmpty: {
                            message: '请选择供应商'
                        }
                    }
                },
                'codePo:number': {
                    validators: {
                        notEmpty: {
                            message: '请选择采购订单编码'
                        }
                    }
                },
                'fromStkId:number': {
                    validators: {
                        notEmpty: {
                            message: '请选择从仓库'
                        }
                    }
                },
                'toStkId:number': {
                    validators: {
                        notEmpty: {
                            message: '请选择到仓库'
                        }
                    }
                }

            }
        }).on('success.form.bv', function(e) {
            e.preventDefault();
            if(!self.validateMatlist()) {
                var top = $('#body').scrollTop();
                $('#nullAlert').css({
                    top: $(window).height() * 0.2 + top
                }).show();
                $('#info').empty();
                $('#info').append('验证不通过');
//                alert('验证不通过');
                return;
            }
            var $form = $(e.target),
            validator = $form.data('bootstrapValidator');
            var mrb =JSON.stringify($('#mrbForm').serializeJSON());
            var jmstoken= store.get('JMS-TOKEN');
            $.saveMtf(mrb,jmstoken,function(data){
                debugger;
                $.get("views/mrbList.html",function(data){
                    $("#body").html(data);
                    RouterManager.setUrl({
                        groupId:'incomeList',
                        viewId:'mrbList'
                    });
                });
//                history.go(-1);
            });
        });
    },
    validateMatlist: function() {
        var $list = $('#matlist');
        var $items = $list.find('.matlist');
        var flag = true;

        if(!$items.length) {
            flag = false;
        }

        $items.each(function(i) {
            var $t = $(this);
            var inventory = $t.find('.n').val();
            var alo = $('.o').val()
            var $qty = $t.find('.h');
            if(!$qty.val() || !parseInt($qty.val()) || parseInt($qty.val()) > parseInt(inventory)|| parseInt($qty.val()) > parseInt(alo)) {
                $t.find('.h').addClass('error');
                flag = false;
            }

        });

        return flag;
    },
    findWSSMtfMaterialBySpoIdAndStkId: function() {
        var self = this;
        var spoId = parseInt($.trim($('#codePo').val()));
        var stkId = parseInt($.trim($('#fromStkId').val()));
        var toStkId = parseInt($.trim($('#toStkId').val()));

        var jmstoken= store.get('JMS-TOKEN');

        if(!stkId) {
            return;
        }

        if(stkId && !spoId) {
            return alert('请选择采购单编码');
        }

        $.poIncomeMatInfo(spoId,stkId,toStkId,store.get('JMS-TOKEN'),function(data){
            var smtfItems = '';
            _(data).each(function(item) {
                if(item.qty>item.qtyStored){
                    item.qty=item.qtyStored;
                }
                item.inventoryQty = item.qtyStored;
//                item.fromBin = item.currentBin;
//                item.fromBinId = item.currentBinId;
                smtfItems += self.createRow(item);
            });
            self.$matList.empty().append(smtfItems);
            var $list = $('#matlist');
            var $items = $list.find('.matlist');
            $items.each(function(i) {
                var $dl = $(this);
                self.loadToBin($dl);
            });
        });
    }
};
newIncomeListEntry.init();


</script>